
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../introduction/3_model_clogit/">
      
      
        <link rel="next" href="../../introduction/4_model_customization/">
      
      
      <link rel="icon" href="../../../logo_choice_learn.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>Nested Logit Usage - Choice-Learn</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../docs/.overrides/assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#the-nested-logit-model" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Choice-Learn" class="md-header__button md-logo" aria-label="Choice-Learn" data-md-component="logo">
      
  <img src="../../../logo_choice_learn.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Choice-Learn
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Nested Logit Usage
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2 12a10 10 0 0 0 13 9.54 10 10 0 0 1 0-19.08A10 10 0 0 0 2 12Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="amber"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m3.55 19.09 1.41 1.41 1.8-1.79-1.42-1.42M12 6c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6c0-3.32-2.69-6-6-6m8 7h3v-2h-3m-2.76 7.71 1.8 1.79 1.41-1.41-1.79-1.8M20.45 5l-1.41-1.4-1.8 1.79 1.42 1.42M13 1h-2v3h2M6.76 5.39 4.96 3.6 3.55 5l1.79 1.81 1.42-1.42M1 13h3v-2H1m12 9h-2v3h2"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Choice-Learn" class="md-nav__button md-logo" aria-label="Choice-Learn" data-md-component="logo">
      
  <img src="../../../logo_choice_learn.png" alt="logo">

    </a>
    Choice-Learn
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HomePage
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/1_introductive_example/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introductive Example
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/2_data_handling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduction to data handling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/3_model_clogit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction to choice modelling with the Conditional Logit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/4_model_customization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction to model customization
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    How-To Guides
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            How-To Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to-guides/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data Handling
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Data Handling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/2_data_handling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intoduction to data handling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/dataset_creation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exhaustive example of ChoiceDataset creation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/features_byID_examples/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimize RAM usage with Features Storage, in-depth examples
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../basket_models/basket_data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basket Data Handling
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modeling Single Choices
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Modeling Single Choices
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../simple_mnl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction to Choice Models - the SimpleMNL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/3_model_clogit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Conditional Logit Usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Nested Logit Usage
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Nested Logit Usage
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#import-the-nested-logit-from-choice-learn" class="md-nav__link">
    <span class="md-ellipsis">
      Import the Nested Logit from Choice-Learn !
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-nested-logit-on-the-swissmetro-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      1- Nested Logit on the SwissMetro dataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1- Nested Logit on the SwissMetro dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#short-introduction-to-nested-logit" class="md-nav__link">
    <span class="md-ellipsis">
      Short Introduction to Nested Logit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specification-and-estimation-with-choice-learn" class="md-nav__link">
    <span class="md-ellipsis">
      Specification and estimation with Choice-Learn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interpretation-and-comparison-with-biogeme-results" class="md-nav__link">
    <span class="md-ellipsis">
      Interpretation and comparison with Biogeme results
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-nested-logit-with-the-hc-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      2- Nested Logit with the HC Dataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2- Nested Logit with the HC Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first-formulation" class="md-nav__link">
    <span class="md-ellipsis">
      First Formulation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#second-formulation" class="md-nav__link">
    <span class="md-ellipsis">
      Second Formulation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#third-formulation" class="md-nav__link">
    <span class="md-ellipsis">
      Third formulation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fourth-formulation" class="md-nav__link">
    <span class="md-ellipsis">
      Fourth Formulation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/4_model_customization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building a custom choice model and handling hyper-parameters
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rumnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RUMnet model Usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../latent_class_model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Latent Class MNLs Usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../logistic_regression/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    A reproductive example, the logistic regression
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models_finetuning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Model Finetuning and general hyperparamters
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../basket_models/shopper/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SHOPPER model Usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tastenet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TasteNet model Usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../halo_mnl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HaloMNL model Usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../learning_mnl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Learning MNL model Usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reslogit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ResLogit model Usage
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modeling Basket of purchases
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            Modeling Basket of purchases
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../basket_models/basket_data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction data handling, the TripDataset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../basket_models/shopper/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Shopper model Usage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../basket_models/alea_carta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AleaCarta model Usage
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Toolbox for choice modellers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            Toolbox for choice modellers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../auxiliary_tools/assortment_example/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimizing a product assortment
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    References
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            References
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/data/references_choice_dataset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ChoiceDataset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/data/references_indexer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ChoiceDataset Indexer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/data/references_storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Features Storage
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Available Open-Source Datasets
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Available Open-Source Datasets
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/datasets/references_base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Base Datasets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/datasets/references_tafeng/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TaFeng Dataset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/datasets/references_expedia/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ICDM Expedia Dataset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/basket_models/datasets/references_bakery/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bakery Dataset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/basket_models/datasets/synthetic_dataset.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Badminton Dataset
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Choice Models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            Choice Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/models/references_base_model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Base Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/models/references_baseline_models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Baseline Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/models/references_simple_mnl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SimpleMNL Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/models/references_clogit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Conditional Logit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/models/references_nested_logit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nested Logit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/models/references_latent_class_base_model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Latent Class BaseModel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/models/references_latent_class_mnl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Latent Class MNL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/models/references_rumnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RUMnet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/models/references_tastenet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TasteNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/models/references_learning_mnl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Learning MNL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/models/references_reslogit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ResLogit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/models/references_halo_mnl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HaloMNL
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Basket Models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            Basket Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/basket_models/references_shopper/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Shopper
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/basket_models/references_alea_carta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The AleaCarta model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/basket_models/references_basic_attention_model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basic Attention model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/basket_models/references_self_attention_model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Self Attention model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/basket_models/data/references_dataset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Trip and TripDataset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/basket_models/data/references_preprocessing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basket preprocessing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/basket_models/utils/references_permutation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Permutation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Toolbox
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            Toolbox
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/toolbox/references_assortment_optimizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Assortment Optimizer and Pricing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_6" >
        
          
          <label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Utils
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6">
            <span class="md-nav__icon md-icon"></span>
            Utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/tf_ops.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tensorflow Operations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../references/utils/metrics.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metrics
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../explanations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explanations
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#import-the-nested-logit-from-choice-learn" class="md-nav__link">
    <span class="md-ellipsis">
      Import the Nested Logit from Choice-Learn !
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-nested-logit-on-the-swissmetro-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      1- Nested Logit on the SwissMetro dataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1- Nested Logit on the SwissMetro dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#short-introduction-to-nested-logit" class="md-nav__link">
    <span class="md-ellipsis">
      Short Introduction to Nested Logit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specification-and-estimation-with-choice-learn" class="md-nav__link">
    <span class="md-ellipsis">
      Specification and estimation with Choice-Learn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interpretation-and-comparison-with-biogeme-results" class="md-nav__link">
    <span class="md-ellipsis">
      Interpretation and comparison with Biogeme results
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-nested-logit-with-the-hc-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      2- Nested Logit with the HC Dataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2- Nested Logit with the HC Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first-formulation" class="md-nav__link">
    <span class="md-ellipsis">
      First Formulation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#second-formulation" class="md-nav__link">
    <span class="md-ellipsis">
      Second Formulation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#third-formulation" class="md-nav__link">
    <span class="md-ellipsis">
      Third formulation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fourth-formulation" class="md-nav__link">
    <span class="md-ellipsis">
      Fourth Formulation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="the-nested-logit-model">The Nested Logit Model</h1>
<p><a href="https://colab.research.google.com/github/artefactory/choice-learn/blob/main/notebooks/models/nested_logit.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<p>The Nested Logit model considers sub-groups of alternatives totally substitutables, called 'nests'. The general idea is that a customer might choose its transportation mode between publics transport and its private car. And then, if he decides to use public transportations the customer chooses between taking the train or the bus.\
The classical Conditional Logit does not account for such decision process. Hence the introduction of the Nested Logit. More detailed information are available <a href="https://cran.r-project.org/web/packages/mlogit/vignettes/c4.relaxiid.html#:~:text=The%20nested%20logit%20model&amp;text=It%20is%20a%20generalization%20of,different%20nests%20are%20still%20uncorrelated.">here</a>.</p>
<p>In this notebook we reproduce results from other packages showing how to speficy a Nested Logit model with Choice-Learn and that we reach the right results.</p>
<h2 id="summary">Summary</h2>
<ul>
<li>[1][Nested Logit on the SwissMetro dataset](#1--nested-logit-on-the-swissmetro-dataset)<ul>
<li><a href="#short-introduction-to-nested-logit">Short Introduction to the Nested Logit model</a></li>
<li><a href="#specification-and-estimation-with-choice-learn">Specification and estimation with Choice-Learn</a></li>
</ul>
</li>
<li>[2][Nested Logit on the HC dataset](#2--nested-logit-with-the-hc-dataset)<ul>
<li><a href="#first-formulation">First formulation</a></li>
<li><a href="#second-formulation">Second formulation</a></li>
<li><a href="#third-formulation">Third formulation</a></li>
<li><a href="#fourth-formulation">Fourth formulation</a></li>
</ul>
</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Install necessary requirements</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="c1"># If you run this notebook on Google Colab, or in standalone mode, you need to install the required packages.</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="c1"># Uncomment the following lines:</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="c1"># !pip install choice-learn</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="c1"># If you run the notebook within the GitHub repository, you need to run the following lines, that can skipped otherwise:</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;../../&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span></code></pre></div>
<h3 id="import-the-nested-logit-from-choice-learn">Import the Nested Logit from Choice-Learn !</h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">choice_learn.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">NestedLogit</span>
</span></code></pre></div>
<h2 id="1-nested-logit-on-the-swissmetro-dataset">1- Nested Logit on the SwissMetro dataset</h2>
<p>We reproduce the results from <a href="https://biogeme.epfl.ch/sphinx/auto_examples/swissmetro/plot_b09nested.html">Biogeme</a> that is also reproduced in <a href="https://github.com/timothyb0912/pylogit/blob/master/examples/notebooks/Nested%20Logit%20Example--Python%20Biogeme%20benchmark--09NestedLogit.ipynb">PyLogit</a>.\
This example uses the SwissMetro dataset further described in the <a href="../introduction/2_data_handling.ipynb">data introduction</a>.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">choice_learn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_swissmetro</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">swiss_dataset</span> <span class="o">=</span> <span class="n">load_swissmetro</span><span class="p">(</span><span class="n">preprocessing</span><span class="o">=</span><span class="s2">&quot;biogeme_nested&quot;</span><span class="p">)</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nb">print</span><span class="p">(</span><span class="n">swiss_dataset</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>%=====================================================================%
%%% Summary of the dataset:
%=====================================================================%
Number of items: 3
Number of choices: 6768
%=====================================================================%
 No Shared Features by Choice registered


 Items Features by Choice:
 2 items features 
 with names: ([&#39;cost&#39;, &#39;travel_time&#39;],)
%=====================================================================%
</code></pre></div>
<h3 id="short-introduction-to-nested-logit">Short Introduction to Nested Logit</h3>
<p>The model specified in Biogeme defines two nests:
- The existing modes nest with the train and car <em>(items indexes of 0 and 2)</em>
- The future modes nest with the swissmetro <em>(item index of 1)</em></p>
<p>And the utility form is the following:\</p>
<p>&nbsp; &nbsp; &nbsp; $U(i) = \beta^{inter}_i + \beta^{tt} \cdot TT(i) + \beta^{co} \cdot CO(i)$\
with:</p>
<ul>
<li>$TT(i)$ the travel time of alternative $i$</li>
<li>$CO(i)$ the cost of alternative $i$</li>
<li>$\beta^{inter}_{sm} = 0$</li>
</ul>
<p>The Nested Logit formulates the following probabilities from such utility:</p>
<p>
<script type="math/tex; mode=display">
\mathbb{P}(i) = \frac{e^{\frac{U(i)}{\gamma_{nest(i)}}} \cdot \left( \sum_{k \in nest(i)} e^{\frac{U(k)}{\gamma_{nest(i)}}} \right)^{\gamma_{nest(i)}-1}}{\sum_{m \in \mathcal{Nests}} \left( \sum_{k \in m} e^{\frac{U(k)}{\gamma_{m}}} \right)^{\gamma_m}}
</script>
</p>
<p>To better understand this expression, one way is to split it into two parts:</p>
<p>
<script type="math/tex; mode=display">
\mathbb{P}(i) = \mathbb{P}(nest(i)) \cdot \mathbb{P}(i | nest(i))
</script>
</p>
<p>with:\
$
\mathbb{P}(i | nest(i)) = \frac{e^{\frac{U(i)}{\gamma_{nest(i)}}} }{\sum_{k \in nest(i)} e^{\frac{U(k)}{\gamma_{nest(i)}}}}
$ &nbsp;
and &nbsp;</p>
<p>$
\mathbb{P}(nest(i))= \frac{\left( \sum_{k \in nest(i)} e^{\frac{U(k)}{\gamma_{nest(i)}}} \right)^{\gamma_{nest(i)}}}{\sum_{m \in \mathcal{Nests}} \left( \sum_{k \in m} e^{\frac{U(k)}{\gamma_{m}}} \right)^{\gamma_m}}
$</p>
<p>Therefore we have 4 weights in the utility function and the $\gamma_{nest}$ values to estimate. The 'new' nest containing only one alternative, its correlation value $\gamma^{new}$ has no impact, we only need to estimate $\gamma^{old}$.</p>
<h3 id="specification-and-estimation-with-choice-learn">Specification and estimation with Choice-Learn</h3>
<p>With Choice-Learn, the Nested Logit model specification is similar to the <a href="./../introduction/3_model_clogit.ipynb">Conditional Logit specification</a>. The few differences are:
- When the model is instantiated, the nested need to be specified as a list of nests with the concerned items indexes. In the example, we specify <code>items_nests=[[0, 2], [1]]</code> saying that first nest contains the items of indexes 0 (train) and 2 (car) and the second nest the item of index 1 (swiss metro).
- The "fast" dict-base specifications has another alternative with <code>coefficients={feature_name: "nest"}</code> creating for the feature feature_name one coefficient to estimate by nest, this coefficient being shared by all alternatives of the nest.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Initialization of the model</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">swiss_model</span> <span class="o">=</span> <span class="n">NestedLogit</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;lbfgs&quot;</span><span class="p">,</span> <span class="n">items_nests</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="c1"># Intercept for train &amp; sm</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="n">swiss_model</span><span class="o">.</span><span class="n">add_coefficients</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;intercept&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="c1"># betas TT and CO shared by train and sm</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="n">swiss_model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;travel_time&quot;</span><span class="p">,</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>                                   <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="n">swiss_model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;cost&quot;</span><span class="p">,</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>                                   <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># Estimation of the model</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">history</span> <span class="o">=</span> <span class="n">swiss_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">swiss_dataset</span><span class="p">,</span> <span class="n">get_report</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>WARNING:tensorflow:AutoGraph could not transform &lt;bound method Socket.send of &lt;zmq.Socket(zmq.PUSH) at 0x7f46435341a0&gt;&gt; and will run it as-is.
Please report this to the TensorFlow team. When filing the bug, set the verbosity to 10 (on Linux, `export AUTOGRAPH_VERBOSITY=10`) and attach the full output.
Cause: module, class, method, function, traceback, frame, or code object was expected, got cython_function_or_method
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert


WARNING:root:At least one gamma value for nests is below 0.05 and is
        clipped to 0.05 for numeric optimization purposes.
WARNING:tensorflow:AutoGraph could not transform &lt;bound method Socket.send of &lt;zmq.Socket(zmq.PUSH) at 0x7f46435341a0&gt;&gt; and will run it as-is.
Please report this to the TensorFlow team. When filing the bug, set the verbosity to 10 (on Linux, `export AUTOGRAPH_VERBOSITY=10`) and attach the full output.
Cause: module, class, method, function, traceback, frame, or code object was expected, got cython_function_or_method
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert


WARNING: AutoGraph could not transform &lt;bound method Socket.send of &lt;zmq.Socket(zmq.PUSH) at 0x7f46435341a0&gt;&gt; and will run it as-is.
Please report this to the TensorFlow team. When filing the bug, set the verbosity to 10 (on Linux, `export AUTOGRAPH_VERBOSITY=10`) and attach the full output.
Cause: module, class, method, function, traceback, frame, or code object was expected, got cython_function_or_method
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert


WARNING:root:L-BFGS Opimization finished:
WARNING:root:---------------------------------------------------------------
WARNING:root:Number of iterations: 21
WARNING:root:Algorithm converged before reaching max iterations: True


Using L-BFGS optimizer, setting up .fit() function
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">swiss_model</span><span class="o">.</span><span class="n">trainable_weights</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>[&lt;tf.Variable &#39;beta_intercept:0&#39; shape=(1, 2) dtype=float32, numpy=array([[-0.51194817, -0.1671558 ]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;beta_travel_time:0&#39; shape=(1, 1) dtype=float32, numpy=array([[-0.89866394]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;beta_cost:0&#39; shape=(1, 1) dtype=float32, numpy=array([[-0.85666543]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;gammas_nests:0&#39; shape=(1, 1) dtype=float32, numpy=array([[0.4868395]], dtype=float32)&gt;]
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">swiss_model</span><span class="o">.</span><span class="n">report</span>
</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient Name</th>
      <th>Coefficient Estimation</th>
      <th>Std. Err</th>
      <th>z_value</th>
      <th>P(.&gt;z)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>beta_intercept_0</td>
      <td>-0.511948</td>
      <td>0.046159</td>
      <td>-11.090872</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>beta_intercept_1</td>
      <td>-0.167156</td>
      <td>0.036682</td>
      <td>-4.556830</td>
      <td>0.000005</td>
    </tr>
    <tr>
      <th>2</th>
      <td>beta_travel_time</td>
      <td>-0.898664</td>
      <td>0.054548</td>
      <td>-16.474657</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>beta_cost</td>
      <td>-0.856665</td>
      <td>0.046482</td>
      <td>-18.430079</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>gammas_nests</td>
      <td>0.486840</td>
      <td>0.029635</td>
      <td>16.427719</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># Looking at the weights</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">swiss_model</span><span class="o">.</span><span class="n">trainable_weights</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>[&lt;tf.Variable &#39;beta_intercept:0&#39; shape=(1, 2) dtype=float32, numpy=array([[-0.51194817, -0.1671558 ]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;beta_travel_time:0&#39; shape=(1, 1) dtype=float32, numpy=array([[-0.89866394]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;beta_cost:0&#39; shape=(1, 1) dtype=float32, numpy=array([[-0.85666543]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;gammas_nests:0&#39; shape=(1, 1) dtype=float32, numpy=array([[0.4868395]], dtype=float32)&gt;]
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Estimating the total summed Negative Log-Likelihood</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">swiss_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">swiss_dataset</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">swiss_dataset</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=5236.8994&gt;
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># Probabilities can be easily computed:</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">probas</span> <span class="o">=</span> <span class="n">swiss_model</span><span class="o">.</span><span class="n">predict_probas</span><span class="p">(</span><span class="n">swiss_dataset</span><span class="p">)</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="nb">print</span><span class="p">(</span><span class="n">probas</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>tf.Tensor(
[[0.15937711 0.6218435  0.21877931]
 [0.1940201  0.6445151  0.16146483]
 [0.11813082 0.597691   0.28417817]
 [0.12110618 0.52606976 0.3528241 ]], shape=(4, 3), dtype=float32)
</code></pre></div>
<h3 id="interpretation-and-comparison-with-biogeme-results">Interpretation and comparison with Biogeme results</h3>
<h2 id="2-nested-logit-with-the-hc-dataset">2- Nested Logit with the HC Dataset</h2>
<p>We reproduce results from <a href="https://cran.r-project.org/web/packages/mlogit/vignettes/e2nlogit.html">mlogit</a> that are also presented in <a href="https://gsbdbi.github.io/torch-choice/nested_logit_model_house_cooling/">Torch-Choice</a>.</p>
<h3 id="first-formulation">First Formulation</h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">choice_learn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_hc</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">choice_learn.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChoiceDataset</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="c1"># Loading</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">hc_df</span> <span class="o">=</span> <span class="n">load_hc</span><span class="p">(</span><span class="n">as_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="c1"># HC dataset is loaded as a pandas.DataFrame for the example.</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="c1"># It can be downloaded as a ChoiceDataset with the argument `as_frame=False`</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">hc_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>rownames</th>
      <th>depvar</th>
      <th>ich.gcc</th>
      <th>ich.ecc</th>
      <th>ich.erc</th>
      <th>ich.hpc</th>
      <th>ich.gc</th>
      <th>ich.ec</th>
      <th>ich.er</th>
      <th>icca</th>
      <th>och.gcc</th>
      <th>och.ecc</th>
      <th>och.erc</th>
      <th>och.hpc</th>
      <th>och.gc</th>
      <th>och.ec</th>
      <th>och.er</th>
      <th>occa</th>
      <th>income</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>erc</td>
      <td>9.70</td>
      <td>7.86</td>
      <td>8.79</td>
      <td>11.36</td>
      <td>24.08</td>
      <td>24.50</td>
      <td>7.37</td>
      <td>27.28</td>
      <td>2.26</td>
      <td>4.09</td>
      <td>3.85</td>
      <td>1.73</td>
      <td>2.26</td>
      <td>4.09</td>
      <td>3.85</td>
      <td>2.95</td>
      <td>20.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>hpc</td>
      <td>8.77</td>
      <td>8.69</td>
      <td>7.09</td>
      <td>9.37</td>
      <td>28.00</td>
      <td>32.71</td>
      <td>9.33</td>
      <td>26.49</td>
      <td>2.30</td>
      <td>2.69</td>
      <td>3.45</td>
      <td>1.65</td>
      <td>2.30</td>
      <td>2.69</td>
      <td>3.45</td>
      <td>1.63</td>
      <td>50.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>gcc</td>
      <td>7.43</td>
      <td>8.86</td>
      <td>6.94</td>
      <td>11.70</td>
      <td>25.71</td>
      <td>31.68</td>
      <td>8.14</td>
      <td>22.63</td>
      <td>2.28</td>
      <td>5.25</td>
      <td>4.35</td>
      <td>1.44</td>
      <td>2.28</td>
      <td>5.25</td>
      <td>4.35</td>
      <td>2.18</td>
      <td>50.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>gcc</td>
      <td>9.18</td>
      <td>8.93</td>
      <td>7.22</td>
      <td>12.13</td>
      <td>29.72</td>
      <td>26.73</td>
      <td>8.04</td>
      <td>25.33</td>
      <td>2.62</td>
      <td>4.89</td>
      <td>4.85</td>
      <td>1.93</td>
      <td>2.62</td>
      <td>4.89</td>
      <td>4.85</td>
      <td>2.70</td>
      <td>50.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>gcc</td>
      <td>8.05</td>
      <td>7.02</td>
      <td>8.44</td>
      <td>10.51</td>
      <td>23.90</td>
      <td>28.35</td>
      <td>7.15</td>
      <td>25.45</td>
      <td>2.52</td>
      <td>3.71</td>
      <td>3.64</td>
      <td>1.63</td>
      <td>2.52</td>
      <td>3.71</td>
      <td>3.64</td>
      <td>2.77</td>
      <td>60.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>It is possible to pre-process the dataset like in the examples to 'easily' specify the Nested Logit model:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">items_id</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gcc&quot;</span><span class="p">,</span> <span class="s2">&quot;ecc&quot;</span><span class="p">,</span> <span class="s2">&quot;erc&quot;</span><span class="p">,</span> <span class="s2">&quot;hpc&quot;</span><span class="p">,</span> <span class="s2">&quot;gc&quot;</span><span class="p">,</span> <span class="s2">&quot;ec&quot;</span><span class="p">,</span> <span class="s2">&quot;er&quot;</span><span class="p">]</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="n">cooling_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gcc&quot;</span><span class="p">,</span> <span class="s2">&quot;ecc&quot;</span><span class="p">,</span> <span class="s2">&quot;erc&quot;</span><span class="p">,</span> <span class="s2">&quot;hpc&quot;</span><span class="p">]</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="n">room_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;erc&quot;</span><span class="p">,</span> <span class="s2">&quot;er&quot;</span><span class="p">]</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="n">non_cooling_modes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gc&quot;</span><span class="p">,</span> <span class="s2">&quot;ec&quot;</span><span class="p">,</span> <span class="s2">&quot;er&quot;</span><span class="p">]</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">items_id</span><span class="p">:</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">cooling_modes</span><span class="p">:</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>        <span class="n">hc_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;icca.</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_df</span><span class="p">[</span><span class="s2">&quot;icca&quot;</span><span class="p">]</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>        <span class="n">hc_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;occa.</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_df</span><span class="p">[</span><span class="s2">&quot;occa&quot;</span><span class="p">]</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>        <span class="n">hc_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;icca.</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>        <span class="n">hc_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;occa.</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items_id</span><span class="p">:</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>    <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cooling_modes</span><span class="p">:</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>        <span class="n">hc_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;int_cooling.</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>        <span class="n">hc_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;inc_cooling.</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_df</span><span class="o">.</span><span class="n">income</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>        <span class="n">hc_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;int_cooling.</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>        <span class="n">hc_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;inc_cooling.</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>    <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">room_modes</span><span class="p">:</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>        <span class="n">hc_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;inc_room.</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hc_df</span><span class="o">.</span><span class="n">income</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>        <span class="n">hc_df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;inc_room.</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># Creating the dataset from this preprocessed dataframe</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">dataset</span> <span class="o">=</span> <span class="n">ChoiceDataset</span><span class="o">.</span><span class="n">from_single_wide_df</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">hc_df</span><span class="p">,</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>                                            <span class="n">items_features_prefixes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ich&quot;</span><span class="p">,</span> <span class="s2">&quot;och&quot;</span><span class="p">,</span> <span class="s2">&quot;occa&quot;</span><span class="p">,</span> <span class="s2">&quot;icca&quot;</span><span class="p">,</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>                                                                     <span class="s2">&quot;int_cooling&quot;</span><span class="p">,</span> <span class="s2">&quot;inc_cooling&quot;</span><span class="p">,</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>                                                                     <span class="s2">&quot;inc_room&quot;</span><span class="p">],</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>                                            <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>                                            <span class="n">items_id</span><span class="o">=</span><span class="n">items_id</span><span class="p">,</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>                                            <span class="n">choices_column</span><span class="o">=</span><span class="s2">&quot;depvar&quot;</span><span class="p">,</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>                                            <span class="n">choice_format</span><span class="o">=</span><span class="s2">&quot;items_id&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>We can use the fast specification using a dictionnary with the 'constant' keyword.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    <span class="s2">&quot;ich&quot;</span><span class="p">:</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="s2">&quot;och&quot;</span><span class="p">:</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="s2">&quot;occa&quot;</span><span class="p">:</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="s2">&quot;icca&quot;</span><span class="p">:</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="s2">&quot;int_cooling&quot;</span><span class="p">:</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>    <span class="s2">&quot;inc_cooling&quot;</span><span class="p">:</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>    <span class="s2">&quot;inc_room&quot;</span><span class="p">:</span> <span class="s2">&quot;constant&quot;</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="p">}</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="n">model</span> <span class="o">=</span> <span class="n">NestedLogit</span><span class="p">(</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>    <span class="n">coefficients</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>    <span class="n">items_nests</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]],</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>    <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;lbfgs&quot;</span><span class="p">,</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>    <span class="n">shared_gammas_over_nests</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># Note the argument specifying that all nests have the same gamma value</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Using L-BFGS optimizer, setting up .fit() function
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">hist</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">get_report</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>WARNING:root:At least one gamma value for nests is below 0.05 and is
        clipped to 0.05 for numeric optimization purposes.
WARNING:root:L-BFGS Opimization finished:
WARNING:root:---------------------------------------------------------------
WARNING:root:Number of iterations: 55
WARNING:root:Algorithm converged before reaching max iterations: True


Using L-BFGS optimizer, setting up .fit() function
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">model</span><span class="o">.</span><span class="n">report</span>
</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient Name</th>
      <th>Coefficient Estimation</th>
      <th>Std. Err</th>
      <th>z_value</th>
      <th>P(.&gt;z)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ich_w_0</td>
      <td>-0.554876</td>
      <td>0.174471</td>
      <td>-3.180328</td>
      <td>0.001471</td>
    </tr>
    <tr>
      <th>1</th>
      <td>och_w_1</td>
      <td>-0.857881</td>
      <td>0.300332</td>
      <td>-2.856437</td>
      <td>0.004284</td>
    </tr>
    <tr>
      <th>2</th>
      <td>occa_w_2</td>
      <td>-1.089362</td>
      <td>1.056226</td>
      <td>-1.031371</td>
      <td>0.302367</td>
    </tr>
    <tr>
      <th>3</th>
      <td>icca_w_3</td>
      <td>-0.225069</td>
      <td>0.112268</td>
      <td>-2.004749</td>
      <td>0.044990</td>
    </tr>
    <tr>
      <th>4</th>
      <td>int_cooling_w_4</td>
      <td>-6.000777</td>
      <td>4.986898</td>
      <td>-1.203308</td>
      <td>0.228857</td>
    </tr>
    <tr>
      <th>5</th>
      <td>inc_cooling_w_5</td>
      <td>0.249571</td>
      <td>0.053589</td>
      <td>4.657146</td>
      <td>0.000003</td>
    </tr>
    <tr>
      <th>6</th>
      <td>inc_room_w_6</td>
      <td>-0.378969</td>
      <td>0.116035</td>
      <td>-3.265980</td>
      <td>0.001091</td>
    </tr>
    <tr>
      <th>7</th>
      <td>gamma_nests</td>
      <td>0.585920</td>
      <td>0.242312</td>
      <td>2.418043</td>
      <td>0.015604</td>
    </tr>
  </tbody>
</table>
</div>

<p>Another possibility is to keep the dataset as is and specify manually the model:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># Creating the dataset</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="n">dataset</span> <span class="o">=</span> <span class="n">ChoiceDataset</span><span class="o">.</span><span class="n">from_single_wide_df</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">hc_df</span><span class="p">,</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>                                            <span class="n">shared_features_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;income&quot;</span><span class="p">],</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>                                            <span class="n">items_features_prefixes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ich&quot;</span><span class="p">,</span> <span class="s2">&quot;och&quot;</span><span class="p">,</span> <span class="s2">&quot;occa&quot;</span><span class="p">,</span> <span class="s2">&quot;icca&quot;</span><span class="p">],</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>                                            <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>                                            <span class="n">items_id</span><span class="o">=</span><span class="n">items_id</span><span class="p">,</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>                                            <span class="n">choices_column</span><span class="o">=</span><span class="s2">&quot;depvar&quot;</span><span class="p">,</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>                                            <span class="n">choice_format</span><span class="o">=</span><span class="s2">&quot;items_id&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>Using the manual specification we define each weight and the indexes of the concerned items.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">model</span> <span class="o">=</span> <span class="n">NestedLogit</span><span class="p">(</span><span class="n">items_nests</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]],</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>                    <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;lbfgs&quot;</span><span class="p">,</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>                    <span class="n">shared_gammas_over_nests</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="c1"># Coefficients that are for all the alternatives</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;ich&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;och&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;icca&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;occa&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="c1"># The coefficients concerning the income are split into two groups of alternatives:</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;income&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">coefficient_name</span><span class="o">=</span><span class="s2">&quot;income_cooling&quot;</span><span class="p">)</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;income&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">coefficient_name</span><span class="o">=</span><span class="s2">&quot;income_room&quot;</span><span class="p">)</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="c1"># Finally only one nest has an intercept</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;intercept&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Using L-BFGS optimizer, setting up .fit() function
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">hist</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">get_report</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>WARNING:root:At least one gamma value for nests is below 0.05 and is
        clipped to 0.05 for numeric optimization purposes.
WARNING:root:L-BFGS Opimization finished:
WARNING:root:---------------------------------------------------------------
WARNING:root:Number of iterations: 39
WARNING:root:Algorithm converged before reaching max iterations: True


Using L-BFGS optimizer, setting up .fit() function
WARNING:tensorflow:5 out of the last 5 calls to &lt;function pfor.&lt;locals&gt;.f at 0x7f459f242b60&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.


WARNING:tensorflow:5 out of the last 5 calls to &lt;function pfor.&lt;locals&gt;.f at 0x7f459f242b60&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.


WARNING:tensorflow:6 out of the last 6 calls to &lt;function pfor.&lt;locals&gt;.f at 0x7f459f16e520&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.


WARNING:tensorflow:6 out of the last 6 calls to &lt;function pfor.&lt;locals&gt;.f at 0x7f459f16e520&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has reduce_retracing=True option that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">model</span><span class="o">.</span><span class="n">report</span>
</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient Name</th>
      <th>Coefficient Estimation</th>
      <th>Std. Err</th>
      <th>z_value</th>
      <th>P(.&gt;z)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>beta_ich</td>
      <td>-0.554878</td>
      <td>0.174468</td>
      <td>-3.180405</td>
      <td>0.001471</td>
    </tr>
    <tr>
      <th>1</th>
      <td>beta_och</td>
      <td>-0.857885</td>
      <td>0.300328</td>
      <td>-2.856494</td>
      <td>0.004283</td>
    </tr>
    <tr>
      <th>2</th>
      <td>beta_icca</td>
      <td>-0.225067</td>
      <td>0.112267</td>
      <td>-2.004751</td>
      <td>0.044990</td>
    </tr>
    <tr>
      <th>3</th>
      <td>beta_occa</td>
      <td>-1.089337</td>
      <td>1.056223</td>
      <td>-1.031352</td>
      <td>0.302376</td>
    </tr>
    <tr>
      <th>4</th>
      <td>income_cooling</td>
      <td>0.249571</td>
      <td>0.053588</td>
      <td>4.657206</td>
      <td>0.000003</td>
    </tr>
    <tr>
      <th>5</th>
      <td>income_room</td>
      <td>-0.378970</td>
      <td>0.116032</td>
      <td>-3.266064</td>
      <td>0.001091</td>
    </tr>
    <tr>
      <th>6</th>
      <td>beta_intercept</td>
      <td>-6.000929</td>
      <td>4.986704</td>
      <td>-1.203386</td>
      <td>0.228827</td>
    </tr>
    <tr>
      <th>7</th>
      <td>gamma_nests</td>
      <td>0.585921</td>
      <td>0.242307</td>
      <td>2.418097</td>
      <td>0.015602</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">model</span><span class="o">.</span><span class="n">trainable_weights</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># The gamma value can be retrieved to compute the correlation as follow:</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">correlation</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">trainable_weights</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correlation over alternatives within each nest:&quot;</span><span class="p">,</span> <span class="n">correlation</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="second-formulation">Second Formulation</h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">model</span> <span class="o">=</span> <span class="n">NestedLogit</span><span class="p">(</span><span class="n">items_nests</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">]],</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>                    <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;lbfgs&quot;</span><span class="p">,</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>                    <span class="n">shared_gammas_over_nests</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="c1"># Coefficients that are for all the alternatives</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;ich&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;och&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;icca&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;occa&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="c1"># The coefficients concerning the income are split into two groups of alternatives:</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;income&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>                             <span class="n">coefficient_name</span><span class="o">=</span><span class="s2">&quot;income_cooling&quot;</span><span class="p">)</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;income&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>                             <span class="n">coefficient_name</span><span class="o">=</span><span class="s2">&quot;income_room&quot;</span><span class="p">)</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="c1"># Finally only one nest has an intercept</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;intercept&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="n">coefficient_name</span><span class="o">=</span><span class="s2">&quot;int.cooling&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">hist</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">get_report</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">model</span><span class="o">.</span><span class="n">report</span>
</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient Name</th>
      <th>Coefficient Estimation</th>
      <th>Std. Err</th>
      <th>z_value</th>
      <th>P(.&gt;z)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>beta_ich</td>
      <td>-1.106775</td>
      <td>1.271377</td>
      <td>-0.870533</td>
      <td>0.384009</td>
    </tr>
    <tr>
      <th>1</th>
      <td>beta_och</td>
      <td>-1.774187</td>
      <td>2.188208</td>
      <td>-0.810794</td>
      <td>0.417484</td>
    </tr>
    <tr>
      <th>2</th>
      <td>beta_icca</td>
      <td>-0.329113</td>
      <td>0.308635</td>
      <td>-1.066349</td>
      <td>0.286266</td>
    </tr>
    <tr>
      <th>3</th>
      <td>beta_occa</td>
      <td>-1.990666</td>
      <td>2.507875</td>
      <td>-0.793766</td>
      <td>0.427332</td>
    </tr>
    <tr>
      <th>4</th>
      <td>income_cooling</td>
      <td>0.405710</td>
      <td>0.425043</td>
      <td>0.954515</td>
      <td>0.339823</td>
    </tr>
    <tr>
      <th>5</th>
      <td>income_room</td>
      <td>-0.737662</td>
      <td>0.742359</td>
      <td>-0.993673</td>
      <td>0.320382</td>
    </tr>
    <tr>
      <th>6</th>
      <td>int.cooling</td>
      <td>-13.468433</td>
      <td>18.365850</td>
      <td>-0.733341</td>
      <td>0.463350</td>
    </tr>
    <tr>
      <th>7</th>
      <td>gamma_nests</td>
      <td>1.323886</td>
      <td>1.889999</td>
      <td>0.700469</td>
      <td>0.483634</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># NLL:</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>&lt;tf.Tensor: shape=(), dtype=float32, numpy=180.03148&gt;
</code></pre></div>
<h3 id="third-formulation">Third formulation</h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">model</span> <span class="o">=</span> <span class="n">NestedLogit</span><span class="p">(</span><span class="n">items_nests</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]],</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>                    <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;lbfgs&quot;</span><span class="p">,</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>                    <span class="n">shared_gammas_over_nests</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="c1"># Coefficients that are for all the alternatives</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;ich&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;och&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;icca&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;occa&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="c1"># The coefficients concerning the income are split into two groups of alternatives:</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;income&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">coefficient_name</span><span class="o">=</span><span class="s2">&quot;income_cooling&quot;</span><span class="p">)</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;income&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">coefficient_name</span><span class="o">=</span><span class="s2">&quot;income_room&quot;</span><span class="p">)</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="c1"># Finally only one nest has an intercept</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;intercept&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">hist</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">get_report</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">model</span><span class="o">.</span><span class="n">trainable_weights</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>[&lt;tf.Variable &#39;beta_ich:0&#39; shape=(1, 1) dtype=float32, numpy=array([[-0.5336982]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;beta_och:0&#39; shape=(1, 1) dtype=float32, numpy=array([[-0.83580786]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;beta_icca:0&#39; shape=(1, 1) dtype=float32, numpy=array([[-0.22605541]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;beta_occa:0&#39; shape=(1, 1) dtype=float32, numpy=array([[-1.1159254]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;income_cooling:0&#39; shape=(1, 1) dtype=float32, numpy=array([[0.24864283]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;income_room:0&#39; shape=(1, 1) dtype=float32, numpy=array([[-0.36347896]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;beta_intercept:0&#39; shape=(1, 1) dtype=float32, numpy=array([[-5.644782]], dtype=float32)&gt;,
 &lt;tf.Variable &#39;gammas_nests:0&#39; shape=(1, 2) dtype=float32, numpy=array([[0.57864326, 0.42460972]], dtype=float32)&gt;]
</code></pre></div>
<h3 id="fourth-formulation">Fourth Formulation</h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">model</span> <span class="o">=</span> <span class="n">NestedLogit</span><span class="p">(</span><span class="n">items_nests</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]],</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>                    <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;lbfgs&quot;</span><span class="p">,</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>                    <span class="n">shared_gammas_over_nests</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="c1"># Coefficients that are for all the alternatives</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;ich&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;och&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;icca&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;occa&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="c1"># The coefficients concerning the income are split into two groups of alternatives:</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;income&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">coefficient_name</span><span class="o">=</span><span class="s2">&quot;income_cooling&quot;</span><span class="p">)</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;income&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">coefficient_name</span><span class="o">=</span><span class="s2">&quot;income_room&quot;</span><span class="p">)</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="c1"># Finally only one nest has an intercept</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="n">model</span><span class="o">.</span><span class="n">add_shared_coefficient</span><span class="p">(</span><span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;intercept&quot;</span><span class="p">,</span> <span class="n">items_indexes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">hist</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">get_report</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="n">model</span><span class="o">.</span><span class="n">report</span>
</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient Name</th>
      <th>Coefficient Estimation</th>
      <th>Std. Err</th>
      <th>z_value</th>
      <th>P(.&gt;z)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>beta_ich</td>
      <td>-0.838395</td>
      <td>0.119850</td>
      <td>-6.995352</td>
      <td>0.000000e+00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>beta_och</td>
      <td>-1.331599</td>
      <td>0.251385</td>
      <td>-5.297053</td>
      <td>1.192093e-07</td>
    </tr>
    <tr>
      <th>2</th>
      <td>beta_icca</td>
      <td>-0.256129</td>
      <td>0.127123</td>
      <td>-2.014806</td>
      <td>4.392505e-02</td>
    </tr>
    <tr>
      <th>3</th>
      <td>beta_occa</td>
      <td>-1.405654</td>
      <td>1.152076</td>
      <td>-1.220105</td>
      <td>2.224251e-01</td>
    </tr>
    <tr>
      <th>4</th>
      <td>income_cooling</td>
      <td>0.311357</td>
      <td>0.055357</td>
      <td>5.624510</td>
      <td>0.000000e+00</td>
    </tr>
    <tr>
      <th>5</th>
      <td>income_room</td>
      <td>-0.571352</td>
      <td>0.082983</td>
      <td>-6.885149</td>
      <td>0.000000e+00</td>
    </tr>
    <tr>
      <th>6</th>
      <td>beta_intercept</td>
      <td>-10.413467</td>
      <td>5.268852</td>
      <td>-1.976421</td>
      <td>4.810715e-02</td>
    </tr>
    <tr>
      <th>7</th>
      <td>gamma_nests</td>
      <td>0.956544</td>
      <td>0.430562</td>
      <td>2.221618</td>
      <td>2.630913e-02</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>
</span></code></pre></div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>